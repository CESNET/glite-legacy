##############################################################################
# Copyright (c) Members of the EGEE Collaboration. 2004.
# See http://www.eu-egee.org/partners/ for details on the copyright
# holders.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
##############################################################################
#
# NAME :        config_gip_px
#
# DESCRIPTION : This function configures the generic information providor (GIP)
#               for MyProxy (PX) node.
#
# AUTHORS :     Shu-Ting.Liao@cern.ch
#               
# NOTES :       The config_gip_<node_type> functions are part of the glite 3.1
#               information system configuration
#
# YAIM MODULE:  glite-yaim-myproxy
#
##############################################################################
config_gip_px_check () {
	requires $1 GRID_TRUSTED_BROKERS SITE_EMAIL SITE_NAME INSTALL_ROOT
}

config_gip_px_setenv () {
	yaimlog DEBUG "This function currently doesn't set any environment variables."
}

config_gip_px () {

	### Auxiliary parameters
	STATIC_CREATE="${INSTALL_ROOT}/glite/sbin/glite-info-static-create"
        TEMPLATE_DIR="${INSTALL_ROOT}/glite/etc"
        CONF_DIR="$INSTALL_ROOT/glite/var/tmp/gip"
        LDIF_DIR="${INSTALL_ROOT}/glite/etc/gip/ldif"

until [ "$GIP_RESPONSE" -ge 0 ]; do
    echo "ERROR: bad GIP_RESPONSE: $GIP_RESPONSE"
    exit 1
done


#### Define output file

if ( echo "${NODE_TYPE_LIST}" | grep -w PX > /dev/null ); then

outfile=${CONF_DIR}/glite-info-static-px.conf

    cat << EOF > $outfile

dn: GlueServiceUniqueID=${PX_HOST}:7512
GlueServiceName: ${SITE_NAME}-myproxy
GlueServiceType: MyProxy
GlueServiceVersion: 1.1.0
GlueServiceEndpoint: ${PX_HOST}:7512
GlueServiceURI: unset
GlueServiceAccessPointURL: myproxy://${PX_HOST}
GlueServiceStatus: OK
GlueServiceStatusInfo: No Problems
GlueServiceWSDL: unset
GlueServiceSemantics: unset
GlueServiceStartTime: 1970-01-01T00:00:00Z
GlueServiceOwner: LCG
GlueForeignKey: GlueSiteUniqueID=${SITE_NAME}
EOF

    split_quoted_variable $GRID_TRUSTED_BROKERS | while read x; do
        echo "GlueServiceAccessControlRule: $x" >> $outfile
    done
	
	### Create static information file
        ldif_file="${LDIF_DIR}/static-file-PX.ldif"
        ${STATIC_CREATE} -c $outfile -t ${TEMPLATE_DIR}/GlueService.template > ${ldif_file}

fi 

	if [ $? -ne 0 ] ; then
            yaimlog WARNING "${STATIC_CREATE} returned an error code!"
        fi
######

        ### Exit with success


return 0
}
